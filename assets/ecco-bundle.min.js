!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("xregexp"),require("d3-array")):"function"==typeof define&&define.amd?define(["exports","d3","xregexp","d3-array"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).eccoBundle={},t.d3,t.XRegExp,t.d3array)}(this,(function(t,e,i,n){"use strict";function a(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=a(i);function r(t){t.classed("token",(function(t,e){return!0})).classed("new-line",(function(t,e){return"\n"===t.token||"\n\n"===t.token})).classed("token-part",(function(t,e){return t.token.length>1&&" "!==t.token[0]||!(1!==t.token.length||!o.default("^\\pL+$").test(t.token))})).classed("input-token",(function(t,e){return"input"===t.type})).classed("output-token",(function(t,e){return"output"===t.type}))}function s(t){return" "===t?" ":"\n"===t?"\\n":"\n\n"===t?"\\n\\n":t}function l(t){let e;var i;return e="#"===t[0]?(i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t))?[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16)]:null:t.substring(4,t.length-1).replace(/ /g,"").split(","),[e[0],e[1],e[2]]}class c{constructor(t={}){this.config={bgColorScaler:t.bgColorScaler||e.scaleLinear().domain([.2,1]).range([0,.5]),bgColorInterpolator:t.bgColorInterpolator||e.interpolateRgb("white","blue"),textColorScaler:t.textColorScaler||e.scaleLinear().domain([0,1]).range([0,1]),textColorInterpolator:t.textColorInterpolator,showPosition:void 0===t.showPosition||t.showPosition,overrideTokenBorderColor:t.overrideTokenBorderColor,valuesKey:t.valuesKey||"values",overrideColorParam:!1},this.parentDivId=t.parentDiv,this.data=t.data}init(){this.div=e.select("#"+this.parentDivId),this.innerDiv=this.div.append("div"),this.innerDiv.style("float","left").style("float","left").style("width","70%");this.setupTokenBoxes(this.data.tokens);this.innerDiv.insert("div",".output-token").attr("class","sequence-indicator outputs-indicator").html(">>")}setupTokenBoxes(t){const i=this;this.innerDiv.selectAll("div.token").data(t,((t,e)=>t.position)).join((t=>t.append("div").attr("token",((t,e)=>t.token)).attr("id",((t,e)=>"t"+e)).attr("position",((t,e)=>e)).attr("value",((t,e)=>t.value||0)).style("opacity",0).style("background-color",((t,e)=>i.bgColor(t))).style("border-color",(()=>{if(i.config.overrideTokenBorderColor)return i.config.overrideTokenBorderColor})).call(r).each((function(t,n){i.config.showPosition&&e.select(this).append("div").attr("class","position_in_seq").text((()=>n)),e.select(this).append("span").text((()=>s(t.token))).style("color",((t,e)=>i.textColor(t.value))).style("padding-left","4px")})).call((t=>t.transition().duration(500).style("opacity",1)))),(t=>t.style("background-color",(t=>i.bgColor(t)))))}bgColor(t){return this.config.overrideColorParam||void 0===t.color?void 0!==t.value?this.config.bgColorInterpolator(this.config.bgColorScaler(t.value)):void 0:t.color}textColor(t){const e=this.config.textColorScaler(t);return this.config.textColorInterpolator?this.config.textColorInterpolator(e):"#000000"}autoTextColor(t){return function(t){let e=l(t);return i=e[0],n=e[1],a=e[2],(.299*i+.587*n+.114*a)/255;var i,n,a}(this.bgColor(t))>.5?"black":"white"}updateData(t,i=null){const n=this.data[this.config.valuesKey][0][t];for(let t=0;t<this.data.tokens.length;t++)this.data.tokens[t].value=n[t]?n[t]:0;i&&(this.config.bgColorInterpolator=e.interpolateRgb("white",i),this.config.bgColorScaler=e.scaleLinear().domain([0,e.max(n)]).range([0,1]))}addToken(t){this.data.tokens.push(t)}redraw(){this.setupTokenBoxes(this.data.tokens)}}class h{constructor(t){this.width=20,this.height=28,this.margin={top:0},this.numericLabelHeight=8,this.barWidth=4,this.barMaxHeight=this.height-this.numericLabelHeight,this.color=e.interpolateViridis,this._scale=e.scaleLinear().domain([0,.4]).range([.85,0])}tinyChart(t){const i=this;t.each((function(t,n){let a=parseFloat(t.value),o=e.select(this).insert("svg",":first-child").style("pointer-events","none").attr("width",i.width).attr("height",i.height).style("margin-left","1px").style("float","left").append("g");const r=e.scaleLinear().domain([0,.3]).range([0,1])(a*i.barMaxHeight);o.append("rect").style("pointer-events","none").attr("y",i.height-i.numericLabelHeight-r).attr("fill",i.color(i.scale(a))).attr("width",i.barWidth).attr("height",((t,e)=>-1===parseFloat(t.value)?0:r)).attr("stroke-width",0).attr("stroke","#333").attr("alignment-baseline","top");const s=(100*a).toFixed(2)+"%";o.append("text").attr("x",0).attr("y",i.barMaxHeight+i.numericLabelHeight-1).text(s).attr("fill",((t,e)=>-1===parseFloat(t.value)?"white":i.color(i.scale(a)))).attr("font-family","sans-serif").attr("font-size","6px").attr("text-anchor","left").attr("alignment-baseline","top").attr("probability",a).style("pointer-events","none")}))}scale(t){return this._scale(t)}}class d extends c{constructor(t){super(t),this.textColor=function(t){return this.scale(t)>.7?"#ffffff":"#000000"}}init(){}textHighlighter(t){const i=this,n=new h;t.each((function(t,a){let o=e.select(this).selectAll("div").data(t,(t=>t.position)).join((t=>t.append("div").style("background-color","green")),(t=>t.style("background-color","red"))).attr("token",((t,e)=>t.token)).attr("id",((t,e)=>"t"+e)).attr("position",((t,e)=>e)).attr("value",((t,e)=>t.value||0)).style("color",((t,e)=>i.textColor(t.value))).call(r,t.token);o.append("span").data((t=>t)).text((function(t){return s(t.token)})).style("margin-left","-13px").style("pointer-events","none"),o.data((t=>t)).call(n.tinyChart.bind(n)),e.select(this).insert("div",":first-child").attr("class","sequence-indicator inputs-indicator").html("input:"),e.select(this).insert("div",".output-token").attr("class","sequence-indicator outputs-indicator").html("output:")}))}}class g{constructor(t={}){this.config={width:t.width||30,height:t.height||30,margin:{top:0,bottom:0,right:0,left:0},numericLabelHeight:t.numericLabelHeight||10,barWidth:t.barWidth||4,colorInterpolator:t.colorInterpolator||e.interpolateViridis,colorScaler:t.colorScaler||e.scaleLinear().domain([0,.4]).range([.85,0]),display_prob_score:t.display_prob_score||!0},this.config.barMaxHeight=t.barMaxHeight||this.config.height-this.config.numericLabelHeight}draw(t){const i=this;t.each((function(t,n){parseFloat(t.value),e.select(this).insert("svg",":first-child").attr("width",i.config.width).attr("height",i.config.height).style("margin-left","1px").style("float","left").append("g")}))}update(){}}class p extends g{constructor(t={}){super(t),this.config.normalizeHeightScale=t.normalizeHeightScale||e.scaleLinear().domain([0,.3]).range([0,1])}draw(t){const i=this;t.each((function(t,n){let a=parseFloat(t.value),o=e.select(this).insert("svg",":first-child").attr("width",i.config.width).attr("height",i.config.height).style("margin-left","1px").style("float","left").append("g");const r=i.config.normalizeHeightScale(a*i.config.barMaxHeight);if(o.append("rect").style("pointer-events","none").attr("y",i.config.height-i.config.numericLabelHeight-r).attr("fill",i.config.colorInterpolator(i.config.colorScaler(a))).attr("width",i.config.barWidth).attr("height",((t,e)=>-1===parseFloat(t.value)?0:r)).attr("stroke-width",0).attr("stroke","#333").attr("alignment-baseline","top"),i.config.display_prob_score){const t=(100*a).toFixed(2)+"%";o.append("text").attr("x",0).attr("y",i.config.barMaxHeight+i.config.numericLabelHeight-1).text(0==a?"":t).attr("fill",((t,e)=>-1===parseFloat(t.value)?"white":i.config.colorInterpolator(i.config.colorScaler(a)))).attr("font-family","sans-serif").attr("font-size","10px").attr("text-anchor","left").attr("alignment-baseline","top").attr("probability",a)}}))}update(t){const i=this;t.each((function(t,n){let a=parseFloat(t.value);const o=i.config.normalizeHeightScale(a*i.config.barMaxHeight);var r=e.transition().duration(100).ease(e.easeLinear);e.select(this).select("rect").transition(r).attr("fill",i.config.colorInterpolator(i.config.colorScaler(a))).attr("y",i.config.height-i.config.numericLabelHeight-o).attr("height",((t,e)=>-1===parseFloat(t.value)?0:o));const s=(100*a).toFixed(2)+"%";e.select(this).select("text").text(0===a?"":s).attr("fill",((t,e)=>-1===parseFloat(t.value)?"white":i.config.colorInterpolator(i.config.colorScaler(a))))}))}scale(t){return this._scale(t)}}class f extends c{constructor(t){super(t),this.tokenSparkline=new p(t.tokenSparkbarConfig)}init(){this.div=e.select("#"+this.parentDivId),this.innerDiv=this.div.append("div");this.setupTokenBoxes(this.data.tokens);this.setupSequenceIndicators(),this.setupInteraction()}setupSequenceIndicators(){this.innerDiv.insert("div",".output-token").attr("class","sequence-indicator outputs-indicator").html(">>")}setupInteraction(){const t=this;this.innerDiv.selectAll("div.output-token").on("mouseenter",((e,i)=>{t.hover(e,i)})).on("touchstart",((e,i)=>{t.hover(e,i)}))}hover(t,e){const i=this;let n=i.innerDiv.selectAll(".input-token").size();i.innerDiv.selectAll('[highlighted="true"]').attr("highlighted",!1).classed("selected",!1).style("background-color",""),i.innerDiv.selectAll(`[position="${t.position}"]`).attr("highlighted",!0).classed("selected",!0).style("background-color","#E1BEE7");i.updateData(t.position-n),i.setupTokenBoxes(i.data.tokens)}selectFirstToken(){const t=this.innerDiv.select(".output-token").attr("position");this.hover({position:t},4)}setupTokenBoxes(t){const i=this;e.scaleLinear().domain([0,1]).range([1,0]);return this.innerDiv.selectAll("div.token").data(t,((t,e)=>t.position)).join((t=>t.append("div").attr("token",((t,e)=>t.token)).attr("id",((t,e)=>"t"+e)).attr("position",((t,e)=>e)).attr("value",((t,e)=>t.value||0)).style("color",((t,e)=>i.textColor(t.value))).style("background-color",(t=>{})).call(r).each((function(t){e.select(this).append("span").text((function(t){return s(t.token)})).style("margin-left","-23px").style("pointer-events","none"),e.select(this).call(i.tokenSparkline.draw.bind(i.tokenSparkline))}))),(t=>t.each((function(t){e.select(this).call(i.tokenSparkline.update.bind(i.tokenSparkline))}))))}updateData(t){const i=this.data.attributions[t];let n=0;for(let t=0;t<this.data.tokens.length;t++)this.data.tokens[t].value=i[t]?i[t]:0,this.data.tokens[t].value>n&&(n=this.data.tokens[t].value);this.tokenSparkline.config.colorScaler=e.scaleLinear().domain([0,n]).range(this.tokenSparkline.config.colorScaler.range()),this.tokenSparkline.config.normalizeHeightScale=e.scaleLinear().domain([0,n]).range(this.tokenSparkline.config.normalizeHeightScale.range())}}class u{constructor(t={}){this.config={margin:t.margin||{top:50,right:30,bottom:30,left:30},overlap:t.overlap||.3},this.config.height=t.height||200+e.min([500,20*t.data.factors[0].length])-this.config.margin.top-this.config.margin.bottom,this.config.width=t.width||350-this.config.margin.left-this.config.margin.right,this.parentDivId=t.parentDiv,this.data=t.data}init(){const t=this,i=this.data.factors[0];i.length;this.div=e.select("#"+this.parentDivId),this.innerDiv=this.div.append("div").attr("id","activation-sparklines").style("float","left").style("width","25%"),this.svg=this.innerDiv.append("svg").attr("viewBox",[0,0,this.config.width,this.config.height]),this.lineColors=e.scaleSequential().domain([0,i.length]).interpolator(e.interpolateRainbow);var n=e.scaleLinear().domain([0,i[0].length]).range([this.config.margin.left,this.config.width-this.config.margin.right]),a=e.scalePoint().domain(i.map(((t,e)=>e))).range([this.config.margin.top,this.config.height-this.config.margin.bottom]);const o=e.scaleLinear().domain([e.min(i,(t=>e.min(t))),e.max(i,(t=>e.max(t)))/2]).range([0,-t.config.overlap*a.step()]);let r=e.line().curve(e.curveCardinal).x(((t,e)=>n(e))).y((t=>o(t)));const s=this.svg.selectAll("g").data(i).join("g").attr("transform",((t,e)=>`translate(0, ${a(e)})`));e.area().defined((t=>!isNaN(t))).x(((t,e)=>n(e))).y0(0).y1(o);s.append("text").attr("fill",((t,e)=>this.lineColors(e))).attr("font-size","20px").text(((t,e)=>e+1)),s.append("path").attr("fill","none").attr("stroke-width",2).attr("stroke",((t,e)=>this.lineColors(e))).attr("d",r),s.append("path").attr("fill","none").attr("opacity",0).attr("stroke-width",30).attr("stroke",((t,e)=>this.lineColors(e))).attr("d",r).on("mouseenter",((e,i)=>{t.hover(i,t.lineColors(i))})).on("touchstart",((e,i)=>{t.hover(i,t.lineColors(i))})).on("mouseleave",((e,i)=>{t.hoverEnd(i,t.lineColors(i))})),this.svg.append("g").attr("transform",`translate(0,${this.config.height-this.config.margin.bottom})`).call(e.axisBottom(n).ticks(5))}hover(t,e){this.hoverAction(t,e)}hoverEnd(t,e){this.hoverEndAction(t,e)}}class v{constructor(t={}){this.config={n_columns:t.n_columns||10,logitsPerLayer:t.logitsPerLayer||10,margin:t.margin||{top:25,right:0,bottom:5,left:0}},this.logitComponent=new b(t.logitBoxConfig),this.config.n_rows=Math.ceil(this.config.logitsPerLayer/this.config.n_columns),this._height=this.config.margin.top+this.config.n_rows*this.logitComponent.height+this.config.margin.bottom,this._width=this.config.margin.left+this.config.n_columns*this.logitComponent.width+this.config.margin.right}draw(t){const i=this;t.each((function(t,n){const a=e.select(this);a.append("text").attr("x",10).attr("y",i.config.margin.top/2+10).text(((t,e)=>void 0!==t[0].layer?"Layer "+t[0].layer:"Layer "+e)).attr("fill","#333").attr("font-family","monospace").attr("font-size","14px").attr("alignment-baseline","middle"),a.append("g").attr("class","logit-group").attr("transform",`translate(0,${i.config.margin.top})`).selectAll("g").data((t=>t)).join("g").attr("class","logit-box").call(i.logitComponent.draw.bind(i.logitComponent)).attr("transform",((t,e)=>{let n=e%i.config.n_columns,a=Math.floor(e/i.config.n_columns);return`translate(${n*i.logitComponent.width}, ${5+a*i.logitComponent.height})`}))}))}set height(t){this._height=t}get height(){return this._height}get width(){return this._width}set width(t){this._width=t}}class b{constructor(t={}){this.config={innerWidth:t.innerWidth||70,innerHeight:t.innerHeight||25,margin:t.margin||{top:5,right:2,bottom:15,left:8}},this._width=this.config.innerWidth+this.config.margin.left+this.config.margin.right,this._height=this.config.innerHeight+this.config.margin.top+this.config.margin.bottom}get width(){return this._width}get height(){return this._height}set height(t){this._height=t}draw(t){const i=this;t.each((function(t,n){const a=e.select(this);a.append("rect").attr("x",i.config.margin.left).attr("y",i.config.margin.top).attr("width",i.config.innerWidth).attr("height",i.config.innerHeight).attr("probability",t.prob).attr("ranking",t.ranking).attr("class","logit").attr("stroke-width",.5).attr("stroke","#ec008c33").attr("fill","#fafafa").attr("rx",3),a.append("text").attr("x",i.config.margin.left+i.config.innerWidth/2).attr("y",i.config.margin.top+i.config.innerHeight/2+5).text((t=>t.token.length>1&&" "!=t.token[0]?"…"+t.token:t.token)).attr("fill","#333").attr("font-family","monospace").attr("font-size",(t=>t.token.length<8?"14px":t.token.length<14?"10px":"6px")).attr("text-anchor","middle").attr("alignment-baseline","middle");const o=t.prob*i.config.innerHeight;a.append("rect").attr("x",i.config.margin.left/2).attr("y",i.config.margin.top+i.config.innerHeight-o-1).attr("fill","#ec008cbb").attr("width",3).attr("height",o).attr("stroke-width",0).attr("stroke","#333").attr("alignment-baseline","top");let r,s=100*t.prob;r=s>99.99?99.99.toFixed(2)+"%":s<.01?"<0.01%":s.toFixed(2)+"%",a.append("text").attr("class","token-text").attr("x",i.config.margin.left/2).attr("y",i.config.margin.top+i.config.innerHeight+10).text(r).attr("fill","#EC008Cbb").attr("font-family","sans-serif").attr("font-size","10px").attr("text-anchor","left").attr("alignment-baseline","top").attr("probability",t.prob),a.append("text").attr("x",i.config.margin.left+2).attr("y",i.config.margin.top+10).text(t.ranking).attr("fill","#999").attr("font-family","sans-serif").attr("font-size","8px").attr("text-anchor","left").attr("alignment-baseline","top")}))}}const k={bgColorScaler:e.scaleLinear().domain([0,1]).range([1,0]),bgColorInterpolator:function(){let t=function(t){for(var e=t.length/6|0,i=new Array(e),n=0;n<e;)i[n]="#"+t.slice(6*n,6*++n);return i}("44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725"),i=t[t.length-1],n=.2*t.length,a=e.interpolateRgb(i,"white"),o=e.range(n).map((t=>a(t/n)));return r=t.concat(o),s=r.length,function(t){return r[Math.max(0,Math.min(s-1,Math.floor(t*s)))]};var r,s}()},m={bgColorScaler:e.scaleLinear().domain([0,.3]).range([0,1]),bgColorInterpolator:e.interpolateRgb("white","purple")};t.ActivationSparklineBase=u,t.AttentionTokenSparkbar=class extends f{constructor(t){t.tokenSparkbarConfig={colorInterpolator:e.interpolateOranges,colorScaler:e.scaleLinear().domain([0,.5]).range([.4,1])},super(t),this.config.margin=t.margin||{top:10,right:10,bottom:10,left:10},this.n_layers=t.data.attentions.length,this.config.layer_box_height=t.layer_box_height||50,this.config.layer_box_width=t.layer_box_width||200,this.config.space_between_layers=10,this.config.height=t.height||this.n_layers*this.config.layer_box_height+this.n_layers*this.config.space_between_layers+this.config.margin.top+this.config.margin.bottom,this.config.width=t.width||this.config.layer_box_width+this.config.margin.left+this.config.margin.right,this.selectedLayer=0,this.selectedToken=this.data.tokens.length-1}init(){this.div=e.select("#"+this.parentDivId),this.innerDiv=this.div.append("div"),this.layerPickerDiv=this.div.insert("div",":first-child").style("float","left").style("width",this.config.width+"px"),this.innerDiv.style("float","left").style("float","left").style("width","70%");this.setupTokenBoxes(this.data.tokens);this.setupSequenceIndicators(),this.setupLayerPicker(),this.setupInteraction(),this.hover({position:this.selectedToken}),this.layerHover(this.selectedLayer)}setupLayerPicker(){const t=this;this.svg=this.layerPickerDiv.append("svg").attr("viewBox",[0,0,this.config.width,this.config.height]),e.range(this.n_layers).forEach((e=>{let i=this.svg.append("g").attr("transform",(()=>`translate(${t.config.margin.left}, ${e*(t.config.layer_box_height+t.config.space_between_layers)+t.config.margin.top})`));i.append("rect").attr("width",this.config.layer_box_width).attr("height",this.config.layer_box_height).attr("rx",15).attr("rx",15).attr("class","layer-box attn-hoverable-layer").attr("layer_num",e),i.append("text").attr("x",this.config.layer_box_width/2).attr("y",this.config.layer_box_height/2).text((()=>"Layer "+e)).attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-family","sans-serif")})),console.log("data",this.data)}setupInteraction(){const t=this;console.log("setting up interaction",this.innerDiv),this.innerDiv.selectAll("div.token").filter((t=>0!==t.position)).classed("attn-hoverable-token",!0).on("mouseenter",((e,i)=>{t.hover(e,i)})).on("touchstart",((e,i)=>{t.hover(e,i)})),this.layerPickerDiv.selectAll("rect.layer-box").on("mouseenter",(function(i,n){t.layerHover(e.select(this).attr("layer_num"))})).on("touchstart",((i,n)=>{t.layerHover(e.select(this).attr("layer_num"))}))}layerHover(t){console.log("switching to layer",t),this.selectedLayer=t;this.layerPickerDiv.selectAll('[highlighted="true"]').classed("attn-hoverable-layer",!0).classed("attn-highlighted-layer",!1).attr("highlighted",!1),this.layerPickerDiv.selectAll(`[layer_num="${t}"]`).attr("highlighted",!0).classed("attn-hoverable-layer",!1).classed("attn-highlighted-layer",!0);this.updateData(this.selectedToken-1),this.setupTokenBoxes(this.data.tokens)}hover(t,e){this.selectedToken=t.position;const i=this;i.innerDiv.selectAll(".input-token").size(),i.innerDiv.selectAll('[highlighted="true"]').classed("attn-hoverable-token",!0).classed("attn-highlighted-token",!1).attr("highlighted",!1),i.innerDiv.selectAll(`[position="${t.position}"]`).attr("highlighted",!0).classed("attn-hoverable-token",!1).classed("attn-highlighted-token",!0);i.updateData(t.position-1),i.setupTokenBoxes(i.data.tokens)}updateData(t){const i=this.data.attentions[this.selectedLayer][t];let n=0;for(let t=0;t<this.data.tokens.length;t++)this.data.tokens[t].value=i[t]?i[t]:0,this.data.tokens[t].value>n&&(n=this.data.tokens[t].value);this.tokenSparkline.config.colorScaler=e.scaleLinear().domain([0,n]).range(this.tokenSparkline.config.colorScaler.range()),console.debug("UPDATING DOMAIN",this.tokenSparkline.config.colorScaler.domain()),this.tokenSparkline.config.normalizeHeightScale=e.scaleLinear().domain([0,n]).range(this.tokenSparkline.config.normalizeHeightScale.range())}},t.InteractiveTokenSparkbar=f,t.LayerPredictions=class{constructor(t={}){this.config={margin:t.margin||{top:50,right:20,bottom:40,left:40},height:8,innerHeight:t.innerHeight||400,width:t.width||800},this.parentDivId=t.parentDiv,this.data=t.data}init(){const t=this,i=this.data[0].length,n=(new b,Math.ceil(t.data[0].length/10),this.data.length),a=new v({n_columns:10,logitsPerLayer:i});this.div=e.select("#"+t.parentDivId),this.innerDiv=this.div.append("div");let o=a.width,r=a.height*n;this.innerDiv.append("svg").attr("class","scrollable").attr("viewBox",[0,0,o,r]).attr("font-family","sans-serif").attr("font-size",10).attr("overflow","scroll").style("overflow","scroll").style("overflow-y","scroll !important").selectAll("g").data(t.data).join("g").attr("class","layer_predictions_group").attr("transform",((t,e)=>`translate(0, ${e*a.height})`)).call(a.draw.bind(a))}},t.LogitBox=b,t.LogitGroup=v,t.MinimalHighlighter=class extends c{constructor(t){if("preset"in t)switch(t.preset){case"viridis":t={...t,...k};break;case"purple":t={...t,...m}}super(t),this.tokenSparkline=new p(t.tokenSparkbarConfig)}init(){this.div=e.select("#"+this.parentDivId),this.innerDiv=this.div.append("div").attr("class","minimal");this.setupTokenBoxes(this.data.tokens);this.setupSequenceIndicators(),this.setupInteraction()}setupSequenceIndicators(){this.innerDiv.insert("div",".output-token").attr("class","sequence-indicator outputs-indicator").html(">>")}setupInteraction(){const t=this;this.innerDiv.selectAll("div.output-token").on("mouseenter",((e,i)=>{t.hover(e,i)})).on("touchstart",((e,i)=>{t.hover(e,i)}))}hover(t,e){const i=this;let n=i.innerDiv.selectAll(".input-token").size();i.innerDiv.selectAll('[highlighted="true"]').classed("selected",!1).attr("highlighted",!1).style("background-color",""),i.innerDiv.selectAll(".token").filter((e=>e.position==t.position)).classed("selected",!0).attr("highlighted",!0);i.updateData(t.position-n),i.setupTokenBoxes(i.data.tokens)}selectFirstToken(){const t=this.innerDiv.select(".output-token").attr("position");this.hover({position:t},4)}setupTokenBoxes(t){const i=this;e.scaleLinear().domain([0,1]).range([1,0]),this.innerDiv.selectAll("div.token").data(t,((t,e)=>t.position)).join((t=>i.enter(t)),(t=>i.update(t)))}enter(t){const i=this;t.append("div").attr("token",((t,e)=>t.token)).attr("id",((t,e)=>"t"+e)).attr("position",((t,e)=>e)).attr("value",((t,e)=>t.value||0)).style("color",((t,e)=>i.autoTextColor(t))).style("background-color",(t=>i.bgColor(t))).call(r).each((function(t){e.select(this).append("span").text((function(t){return s(t.token)}))}))}update(t){const e=this;t.attr("value",((t,e)=>t.value||0)).style("background-color",(t=>e.bgColor(t))).selectAll("span").style("color",((t,i)=>e.autoTextColor(t)))}updateData(t){const i=this.data.attributions[t];let n=0;for(let t=0;t<this.data.tokens.length;t++)this.data.tokens[t].value=i[t]?i[t]:0,this.data.tokens[t].value>n&&(n=this.data.tokens[t].value);this.config.bgColorScaler=e.scaleLinear().domain([0,n]).range(this.config.bgColorScaler.range()),this.tokenSparkline.config.colorScaler=e.scaleLinear().domain([0,n]).range(this.tokenSparkline.config.colorScaler.range()),this.tokenSparkline.config.normalizeHeightScale=e.scaleLinear().domain([0,n]).range(this.tokenSparkline.config.normalizeHeightScale.range())}},t.TextHighlighter=c,t.TinyChartTextHighlighter=d,t.TokenSparkbar=p,t.TokenSparkbarBase=g,t.bgHighlighterSequence=function(t,e){new c({parentDiv:t,data:e,showPosition:!1,overrideTokenBorderColor:"white"}).init()},t.interactiveTokens=function(t,e){const i=new f({parentDiv:t,data:e});i.init(),i.selectFirstToken()},t.interactiveTokensAndFactorSparklines=function(t,i,a={}){window.d=i;const o=new u({...a.actSparklineCFG,parentDiv:t,data:i});o.init();const r=new c({...a.hltrCFG,parentDiv:t,data:i,showPosition:!1,overrideTokenBorderColor:"white",valuesKey:"factors"});let s=[];i.tokens.map(((t,e)=>{s.push(n.maxIndex(i.factors[0],(t=>t[e])))}));let l=[],h=[];i.factors[0].map(((t,i)=>{let n=o.lineColors(i);l.push(e.interpolateRgb("white",n)),h.push(e.scaleLinear().domain([0,e.max(t)]).range([0,1]))}));for(let t=0;t<i.tokens.length;t++){let e=s[t];i.tokens[t].color=l[e](h[e](i.factors[0][e][t]))}r.init(),o.hoverAction=function(t,e){r.config.overrideColorParam=!0,r.updateData(t,e),r.redraw()},o.hoverEndAction=function(t,e){r.config.overrideColorParam=!1,r.redraw()}},t.renderOutputSequence=function(t,e){const i=new c({parentDiv:t,data:e});return i.init(),i},t.renderSeqHighlightPosition=function(t,i,n){const a=e.select("#"+t),o=(n.tokens.length,new d);let r=a.selectAll("div").data([n.tokens]).join("div").call(o.textHighlighter.bind(o)),s=e.selectAll(`[position="${i}"]`).style("border","1px solid #8E24AA");o.init(),console.log("Selection",r,s)},t.version="0.0.4",Object.defineProperty(t,"__esModule",{value:!0})}));
